<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"%3E%3Cdefs%3E%3ClinearGradient id="g" x1="0" y1="0" x2="1" y2="1"%3E%3Cstop stop-color="%23ff6a00"/%3E%3Cstop offset="1" stop-color="%23ffb37a"/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="64" height="64" fill="%230b0b0d"/%3E%3Ccircle cx="32" cy="32" r="18" fill="url(%23g)"/%3E%3C/svg%3E'>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CrAIg's Creations — OSRS Bot Farm</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0a0a; --card:#111111; --border:#222222; --text:#e0e0e0; --muted:#888888;
      --brand:#ff6a00; --brand-light:#ffb380; --success:#22c55e; --warning:#f59e0b; --danger:#ef4444;
      --info:#3b82f6; --chip:#1a1a1f;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:16px}
    .container{max-width:1650px;margin:0 auto}
    .header{display:flex;justify-content:space-between;align-items:center;padding:16px 0;margin-bottom:24px;border-bottom:1px solid var(--border)}
    .logo{font-size:24px;font-weight:700;background:linear-gradient(135deg,var(--brand),var(--brand-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .stats-bar{display:flex;gap:16px;flex-wrap:wrap}
    .stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 16px;min-width:140px;text-align:center;position:relative;overflow:hidden}
    .stat::before{content:'';position:absolute;top:0;left:0;width:100%;height:2px;background:linear-gradient(90deg,var(--brand),var(--brand-light));opacity:0;transition:opacity .3s}
    .stat:hover::before{opacity:1}
    .stat-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
    .stat-value{font-size:20px;font-weight:700;margin-top:4px;transition:transform .3s}
    .stat:hover .stat-value{transform:scale(1.05)}

    .tabs{display:flex;gap:10px;margin-bottom:8px;border-bottom:1px solid var(--border);flex-wrap:wrap}
    .tab{padding:10px 14px;cursor:pointer;border-bottom:2px solid transparent;font-weight:600;color:var(--muted);transition:all .2s;position:relative}
    .tab::after{content:'';position:absolute;bottom:-1px;left:50%;width:0;height:2px;background:var(--brand);transition:width .3s,left .3s}
    .tab.active{color:var(--brand-light);border-bottom-color:var(--brand)}
    .tab.active::after{width:100%;left:0}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;transition:all .3s;position:relative}
    .card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--brand),var(--brand-light));opacity:0;transition:opacity .3s}
    .card:hover::before{opacity:1}
    .card:hover{transform:translateY(-6px);box-shadow:0 12px 40px rgba(0,0,0,.4)}
    .card-header{padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .account-name{font-weight:600;font-size:16px}
    .rsn{font-size:12px;color:var(--muted);margin-top:2px}
    .status{padding:4px 10px;border-radius:999px;font-size:11px;font-weight:600;text-transform:uppercase;position:relative;overflow:hidden}
    .status::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .6s}
    .status.running::before{animation:shimmer 2s infinite}
    @keyframes shimmer{0%{left:-100%}100%{left:100%}}
    .status-running{background:#166534;color:#86efac}
    .status-stopped{background:#451a03;color:#fdba74}
    .status-starting{background:#1e3a8a;color:#93c5fd}

    .task-bar{background:linear-gradient(90deg,var(--brand),var(--brand-light));color:black;padding:8px 12px;font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;position:relative}
    .task-bar::after{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);animation:shimmer 3s infinite}

    .stats-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;padding:16px}
    .stat-item{text-align:center;position:relative}
    .stat-item::after{content:'';position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);width:30px;height:1px;background:var(--muted);opacity:0;transition:opacity .3s}
    .stat-item:hover::after{opacity:.3}
    .stat-item-label{font-size:11px;color:var(--muted);text-transform:uppercase}
    .stat-item-value{font-size:18px;font-weight:700;margin-top:4px;position:relative}

    .actions{padding:12px 16px;display:flex;gap:8px}
    .btn{flex:1;padding:10px;border:none;border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
    .btn::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;background:rgba(255,255,255,.2);border-radius:50%;transform:translate(-50%,-50%);transition:width .3s,height .3s}
    .btn:active::before{width:300px;height:300px}
    .btn-start{background:var(--success);color:white}
    .btn-stop{background:var(--danger);color:white}
    .btn-warn{background:var(--warning);color:black}
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.3)}

    .live-dot{width:8px;height:8px;background:var(--success);border-radius:50%;display:inline-block;margin-right:6px;animation:pulse 1.5s infinite}
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.2)}}

    .empty{text-align:center;padding:60px;color:var(--muted);font-size:18px}
    .loading{animation:fade 1.5s infinite}
    @keyframes fade{0%,100%{opacity:.3}50%{opacity:1}}

    .tab-content{display:none}
    .tab-content.active{display:block}
    .panel{border:1px solid var(--border);border-radius:10px;background:var(--card);margin:10px 0}
    .panel-header{list-style:none;cursor:pointer;display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:linear-gradient(180deg,rgba(255,106,0,0.07),rgba(0,0,0,0));border-bottom:1px solid var(--border);border-radius:10px}
    .panel-header::-webkit-details-marker{display:none}
    .panel-title{display:flex;align-items:center;gap:10px;font-weight:700}
    .panel-body{padding:14px}
    .control-row{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap;align-items:center}
    .control-group{display:flex;flex-direction:column;gap:6px;flex:1;min-width:220px}
    .control-label{font-size:11px;color:var(--muted);text-transform:uppercase;font-weight:700;letter-spacing:.04em}
    input,select,textarea{padding:9px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:#0e0e12;color:var(--text);width:100%}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(255,106,0,.12)}
    .btn{padding:10px 14px;border:none;border-radius:8px;font-weight:700;cursor:pointer;transition:.15s;font-size:13px;display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#131318;color:var(--text)}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:linear-gradient(135deg,var(--brand),var(--brand-light));color:black}
    .btn-ok{background:#0f2016;color:#a7f3d0;border-color:#0f2919}
    .btn-warn{background:#231a0b;color:#fde68a;border-color:#33240c}
    .btn-bad{background:#220e0e;color:#fecaca;border-color:#311010}
    .btn-info{background:#0c1625;color:#bfdbfe;border-color:#152236}
    .btn-chip{background:var(--chip)}
    .btn-group{display:flex;gap:8px;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse}
    th{background:#121218;padding:10px;text-align:left;font-weight:700;color:#e8e9ea;border-bottom:1px solid var(--border);font-size:12px;text-transform:uppercase;position:sticky;top:0;z-index:1}
    td{padding:10px;border-bottom:1px solid var(--border);font-size:14px;vertical-align:middle}
    tr:hover{background:#131318}
    .checkbox-cell{text-align:center}
    .status-badge{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800;display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:var(--chip)}
    .status-running{color:#86efac;background:#0d1a12;border-color:#193021}
    .status-stopped{color:#fecaca;background:#1a0d0d;border-color:#301515}
    .status-starting{color:#bfdbfe;background:#0c1625;border-color:#152236}
    .status-queued{color:#fde68a;background:#231a0b;border-color:#33240c}
    .editable-select{background:#0e0e12}
    .toast{position:fixed;bottom:18px;right:18px;background:#131318;color:#fff;padding:14px 16px;border-radius:8px;border:1px solid var(--border);box-shadow:0 10px 30px rgba(0,0,0,.45);transform:translateY(120px);opacity:0;transition:.25s;max-width:460px;z-index:1000}
    .toast.show{transform:translateY(0);opacity:1}
    .toast.ok{border-color:#14532d}
    .toast.bad{border-color:#3f1515}
    .toast.warn{border-color:#3a2a0f}
    .toast.info{border-color:#152236}
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER WITH STATS BAR -->
    <div class="header">
      <div class="logo">OSRS Bot Farm</div>
      <div class="stats-bar">
        <div class="stat"><div class="stat-label">Running</div><div id="running-count" class="stat-value">0</div></div>
        <div class="stat"><div class="stat-label">Total GP</div><div id="total-gp" class="stat-value">0</div></div>
        <div class="stat"><div class="stat-label">Avg Mem</div><div id="avg-mem" class="stat-value">0d</div></div>
      </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <div class="tab active" data-tab="overview">Live Grid</div>
      <div class="tab" data-tab="accounts">Accounts</div>
      <div class="tab" data-tab="bans">Bans</div>
      <div class="tab" data-tab="hiscores">Hiscores</div>
      <div class="tab" data-tab="settings">Settings</div>
      <div class="tab" data-tab="advanced">Advanced</div>
    </div>

    <!-- OVERVIEW GRID -->
    <div id="overview-tab" class="tab-content active">
      <details class="panel" open>
        <summary class="panel-header"><span class="panel-title">Live Overview</span></summary>
        <div class="panel-body">
          <div class="control-row" style="margin-bottom:16px">
            <div class="btn-group">
              <button class="btn btn-chip active" data-filter="all" onclick="filterOverview('all')">All</button>
              <button class="btn btn-chip" data-filter="running" onclick="filterOverview('running')">Running</button>
              <button class="btn btn-chip" data-filter="starting" onclick="filterOverview('starting')">Starting</button>
              <button class="btn btn-chip" data-filter="stopped" onclick="filterOverview('stopped')">Stopped</button>
              <button class="btn btn-chip" data-filter="stalled" onclick="filterOverview('stalled')">Stalled</button>
            </div>
          </div>
          <div id="overview-grid" class="grid">
            <div class="empty loading">Initializing bots...</div>
          </div>
        </div>
      </details>
    </div>

    <!-- ACCOUNTS TAB -->
    <div id="accounts-tab" class="tab-content">
      <details class="panel" open>
        <summary class="panel-header">
          <span class="panel-title">Account Management</span>
          <span class="panel-meta" id="account-count">0 accounts</span>
        </summary>
        <div class="panel-body">
		<div class="control-row" style="margin-bottom:12px">
		  <div class="control-group" style="max-width:420px">
			<label class="control-label">Search</label>
			<input id="search-accounts" placeholder="Search username, plugin, args…" />
		  </div>
		  <div class="control-group" style="flex:0 0 auto;align-self:flex-end">
			<div class="btn-group">
			  <button id="btn-manual-refresh" class="btn btn-chip">Refresh Now</button>
			  <button id="btn-bulk-start" class="btn btn-primary">Start Selected</button>
			  <button id="btn-bulk-stop" class="btn btn-bad">Stop Selected</button>
			  <button id="btn-bulk-restart" class="btn btn-warn">Restart Selected</button>
			</div>
		  </div>
		</div>

		<!-- REFRESH STATUS INDICATOR -->
		<div style="margin-top:8px;font-size:12px;color:var(--muted);display:flex;align-items:center;gap:6px">
		  <span id="refresh-status" style="font-weight:600;color:#f59e0b">Auto-refresh paused</span>
		  <span class="live-dot" style="background:#f59e0b;animation:pulse 1.5s infinite"></span>
		</div>
          <table>
            <thead>
              <tr>
                <th class="checkbox-cell"><input id="select-all" type="checkbox" /></th>
                <th>Account</th>
                <th>RSN</th>
                <th>Status</th>
                <th>Plugin</th>
                <th>Args</th>
                <th>PAB URL</th>
                <th>Proxy</th>
                <th>Server</th>
                <th>PID</th>
                <th>Runtime</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="accounts-tbody"></tbody>
          </table>
        </div>
      </details>
    </div>

    <!-- BANS TAB -->
    <div id="bans-tab" class="tab-content">
      <details class="panel" open>
        <summary class="panel-header"><span class="panel-title">Bans & Notes</span></summary>
        <div class="panel-body">
          <div class="control-row">
            <div class="control-group" style="max-width:360px">
              <label class="control-label">Filter</label>
              <select id="ban-filter">
                <option value="all">All</option>
                <option value="banned">Banned only</option>
                <option value="clear">Not banned</option>
              </select>
            </div>
            <div class="control-group" style="max-width:360px">
              <label class="control-label">Search</label>
              <input id="ban-search" placeholder="Search username or note…" />
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Account</th>
                <th>Flag</th>
                <th>Note</th>
                <th>Save</th>
              </tr>
            </thead>
            <tbody id="bans-tbody"></tbody>
          </table>
        </div>
      </details>
    </div>

    <!-- HISCORES TAB -->
    <div id="hiscores-tab" class="tab-content">
      <details class="panel" open>
        <summary class="panel-header"><span class="panel-title">Hiscores Lookup</span></summary>
        <div class="panel-body">
          <div class="control-row">
            <div class="control-group">
              <label class="control-label">Username</label>
              <input id="hs-user" placeholder="Exact in-game name" />
            </div>
            <div class="control-group" style="flex:0 0 auto;align-self:flex-end">
              <div class="btn-group">
                <button id="hs-from-selected" class="btn btn-chip">Use first selected</button>
                <button id="hs-fetch" class="btn btn-primary">Fetch</button>
                <button id="hs-refresh-all" class="btn btn-good">Refresh All</button>
              </div>
            </div>
          </div>
		  
		  <div class="control-row" style="margin-bottom:12px">
			<div class="control-group" style="max-width:420px">
				<label class="control-label">Search</label>
				<input id="search-accounts" placeholder="Search username, plugin, args…" />
			</div>
		<div class="control-group" style="flex:0 0 auto;align-self:flex-end">
			<div class="btn-group">
			  <button id="btn-manual-refresh" class="btn btn-chip">Refresh Now</button>
			  <button id="btn-bulk-start" class="btn btn-primary">Start Selected</button>
			  <button id="btn-bulk-stop" class="btn btn-bad">Stop Selected</button>
			  <button id="btn-bulk-restart" class="btn btn-warn">Restart Selected</button>
			</div>
		  </div>
		</div>
		  
          <div id="hs-result" style="margin-top:8px"></div>
          <div id="hs-all-accounts" style="margin-top:16px"></div>
        </div>
      </details>
    </div>

    <!-- SETTINGS TAB -->
    <div id="settings-tab" class="tab-content">
      <details class="panel" open>
        <summary class="panel-header"><span class="panel-title">Launcher & Paths</span></summary>
        <div class="panel-body">
          <div class="control-row">
            <div class="control-group">
              <label class="control-label">Launcher Provider</label>
              <select id="launcher-provider">
                <option value="pure">PureLauncher</option>
                <option value="custom">Custom</option>
                <option value="rl">RuneLite</option>
                <option value="rlpl">RuneLite+PL</option>
                <option value="storm">Storm</option>
                <option value="vitalite">VitaLite</option>
              </select>
            </div>
            <div class="control-group">
              <label class="control-label">Launch Delay (s)</label>
              <input type="number" id="launch-delay" value="10" min="1" max="300" />
            </div>
            <div class="control-group">
              <label class="control-label">Global Proxy</label>
              <input id="global-proxy" placeholder="host:port:user:pass" />
            </div>
            <div class="control-group">
              <label class="control-label">PAccountBuilder URL (fallback)</label>
              <input id="pab-url" placeholder="https://example.com/task.json" />
            </div>
          </div>
		  <div class="control-row">
		  <div class="control-group">
			<label class="control-label">Discord Webhook URL</label>
			<input id="discord-webhook" placeholder="https://discord.com/api/webhooks/..." style="font-size:12px" />
		  </div>
		</div>
          <div class="control-row">
            <div class="control-group" style="flex:2">
              <label class="control-label">PureLauncher Path</label>
              <input id="purelauncher-path" placeholder="C:\PureLauncher\PureLauncher.exe" />
            </div>
            <div class="btn-group" style="align-self:flex-end">
              <button id="btn-test-pl" class="btn btn-info">Test</button>
              <button id="btn-save-pl" class="btn btn-ok">Save Path</button>
            </div>
          </div>
          <div style="margin-top:6px">
            <span id="pl-status" class="connection-status">Not configured</span>
          </div>
          <div style="margin-top:10px">
            <button id="btn-save-settings" class="btn btn-primary">Save All Settings</button>
          </div>
        </div>
      </details>
    </div>

    <!-- ADVANCED TAB -->
    <div id="advanced-tab" class="tab-content">
      <details class="panel" open>
        <summary class="panel-header"><span class="panel-title">Advanced</span></summary>
        <div class="panel-body">
          <div class="control-row">
            <div class="control-group">
              <label class="control-label">Batch Proxy Update</label>
              <input id="batch-proxy" placeholder="host:port:user:pass" />
            </div>
            <div class="btn-group" style="align-self:flex-end">
              <button id="btn-update-proxy" class="btn btn-warn">Update Selected</button>
              <button id="btn-stop-all" class="btn btn-bad">Stop ALL</button>
              <button id="btn-clear" class="btn btn-chip">Clear Local Data</button>
              <button id="btn-export" class="btn btn-info">Export</button>
            </div>
          </div>
        </div>
      </details>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
	const API_BASE = 'https://osrs-dashboard.onrender.com';
	const AGENT_BASE = 'http://localhost:3001';
	const WS_URL = 'ws://localhost:3002';
	
	// === GLOBAL STATE ===
	let currentTab = 'overview';
	let blockRenderAccounts = false;
	let autoRefreshEnabled = true;

	// === WEBSOCKET SETUP (MUST BE FIRST) ===
	const ws = new WebSocket(WS_URL);
	ws.onopen = () => console.log('WebSocket connected');
	ws.onerror = (err) => console.error('WebSocket error:', err);
	ws.onclose = () => console.log('WebSocket closed');

    const REFRESH_MS = 5000;
    const STALL_MS = 120000;
    const UNSEEN_MS = 300000;
    const AUTO_UNSTICK = false;
    const seenMap = new Map();
    let accounts = [];
    const overlays = new Map();
    const selectedAccounts = new Set();
    let settings = { launcher:'pure', delay:10, globalProxy:'', pabUrl:'', pureLauncherPath:'' };
    let timer = null;

    // === WEBSOCKET ===
	ws.onmessage = (e) => {
	  const msg = JSON.parse(e.data);
	  if (msg.type === 'state') {
		msg.data.forEach(bot => {
		  const o = overlays.get(bot.username) || {};
		  o.currentTask = bot.currentTask;
		  overlays.set(bot.username, o);
		});
		renderOverview();
		if (currentTab !== 'accounts') renderAccounts();
	  } else if (msg.type === 'task') {
		const o = overlays.get(msg.username) || {};
		o.currentTask = msg.task;
		overlays.set(msg.username, o);
		renderOverview();
		if (currentTab !== 'accounts') renderAccounts();
	  }
	};

    // === FULL LOGIC (CLEAN, NO DEBUG) ===
    function setRefreshUi(){
      const btn = document.getElementById('btn-auto-refresh');
      const ind = document.getElementById('refresh-indicator');
      if (!btn || !ind) return;
      btn.textContent = autoRefreshEnabled ? 'Auto Refresh' : 'Auto Refresh';
      ind.textContent = autoRefreshEnabled ? 'Auto' : 'Manual';
      ind.className = 'connection-status ' + (autoRefreshEnabled ? 'status-connected' : 'status-offline');
    }
    function startAutoRefresh(){
      stopAutoRefresh();
      timer = setInterval(refreshAccounts, REFRESH_MS);
      autoRefreshEnabled = true;
      setRefreshUi();
    }
    function stopAutoRefresh(){
      if (timer){ clearInterval(timer); timer = null; }
      autoRefreshEnabled = false;
      setRefreshUi();
    }
    function toggleAutoRefresh(){ autoRefreshEnabled ? stopAutoRefresh() : startAutoRefresh(); }
    let pauseUntil = 0;
    function pauseRefresh(ms=4000){ pauseUntil = Date.now() + ms; }
    const ALLOWED_KEYS = new Set([
      'demon.start','el.start','repcal.start',
      'paccountbuilder.autostart','bh.creds','profile','autostart'
    ]);
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const escapeHtml = (s)=>String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    const isPresent = v => v != null && v !== '' && v !== 'none';
    const isHttpUrl = v => /^https?:\/\/\S+$/i.test(v);
    function formatGP(value) {
      if (!value) return 'N/A';
      if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
      if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
      return value.toString();
    }
    function formatNumber(value) {
      if (value === null || value === undefined) return 'N/A';
      if (value >= 1000000) return `${(value / 1000000).toFixed(1)}M`;
      if (value >= 1000) return `${(value / 1000).toFixed(1)}K`;
      return value.toString();
    }
    function normalizePabUrl(url) {
      if (!url) return url;
      if (url.includes('pastebin.com/') && !url.includes('/raw/')) {
        url = url.replace(/pastebin\.com\/([a-zA-Z0-9]+)/, 'pastebin.com/raw/$1');
      }
      return url;
    }
    function showToast(msg, kind='info'){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.className = `toast show ${kind}`;
      setTimeout(()=>el.classList.remove('show'), 2800);
    }
    function appendFeed(line){
      const feed = document.getElementById('live-feed');
      if (!feed) return;
      const div = document.createElement('div');
      div.className = 'feed-item';
      div.textContent = line;
      feed.appendChild(div);
      feed.scrollTop = feed.scrollHeight;
    }
    async function safeFetch(url, opts={}, timeoutMs=10000){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), timeoutMs);
      try {
        const res = await fetch(url, { ...opts, signal: ctrl.signal, cache: 'no-store' });
        clearTimeout(t);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res;
      } catch (e) {
        clearTimeout(t);
        throw e;
      }
    }
    function markSeen(a){
      const s = seenMap.get(a.username) || {};
      s.lastSeen = Date.now();
      if (a.status === 'starting') {
        if (!s.startingSince) s.startingSince = Date.now();
      } else {
        s.startingSince = 0;
      }
      if (a.pid) s.lastPid = a.pid;
      seenMap.set(a.username, s);
    }
    function deriveUiStatus(a){
      const s = seenMap.get(a.username) || {};
      const ov = overlays.get(a.username) || {};
      if (a.status === 'running' && ov.currentTask === 'Stopped') {
        return 'dcerror';
      }
      if (a.status === 'starting' && s.startingSince && Date.now() - s.startingSince > STALL_MS) return 'stalled';
      if (a.status === 'running' && (!a.pid || !a.startTime) && s.lastSeen && Date.now() - s.lastSeen > STALL_MS) return 'stalled';
      if (s.lastSeen && Date.now() - s.lastSeen > UNSEEN_MS) return 'offline';
      return a.status || 'stopped';
    }
    async function stallGuard(){
      if (!AUTO_UNSTICK) return;
      const stalled = accounts.filter(a => deriveUiStatus(a) === 'stalled');
      for (const a of stalled){
        try { await apiStop(a.username); appendFeed(`[stall] forced stop: ${a.username}`); } catch {}
      }
    }
	function loadSettings(){
	  const saved = localStorage.getItem('dashboard-settings');
	  if (saved) settings = { ...settings, ...JSON.parse(saved) };
	  
	  const lp = document.getElementById('launcher-provider'); if (lp) lp.value = settings.launcher || 'pure';
	  const ld = document.getElementById('launch-delay'); if (ld) ld.value = settings.delay || 10;
	  const gp = document.getElementById('global-proxy'); if (gp) gp.value = settings.globalProxy || '';
	  const pu = document.getElementById('pab-url'); if (pu) pu.value = settings.pabUrl || '';
	  const dw = document.getElementById('discord-webhook'); if (dw) dw.value = settings.discordWebhook || '';
	}
	function saveSettings(){
	  settings.launcher = document.getElementById('launcher-provider')?.value || 'pure';
	  settings.delay = parseInt(document.getElementById('launch-delay')?.value) || 10;
	  settings.globalProxy = document.getElementById('global-proxy')?.value.trim() || '';
	  settings.pabUrl = normalizePabUrl(document.getElementById('pab-url')?.value.trim() || '');
	  settings.discordWebhook = document.getElementById('discord-webhook')?.value.trim() || '';

	  const pabInput = document.getElementById('pab-url');
	  if (pabInput) pabInput.value = settings.pabUrl;

	  localStorage.setItem('dashboard-settings', JSON.stringify(settings));
	  
	  safeFetch(`${API_BASE}/api/settings`, {
		method:'POST',
		headers:{'Content-Type':'application/json'},
		body: JSON.stringify(settings)
	  }).catch(()=>{});
	  
	  showToast('Settings saved (including Discord webhook)', 'ok');
	}
    function sanitiseArgs(args){
      if (!args) return '';
      return args.split('&')
        .map(s=>s.trim()).filter(Boolean)
        .map(kv=>kv.split('='))
        .filter(([k,v])=>ALLOWED_KEYS.has(k) && v !== undefined && v !== '')
        .map(([k,v])=>`${k}=${v}`).join('&');
    }
    function resolveArgsForUser(rawArgs, username){
      let a = rawArgs || '';
      if (a.includes('{url}')) {
        const perUser = overlays.get(username)?.pabUrl;
        const fallback = settings.pabUrl;
        const chosen = isHttpUrl(perUser) ? perUser : isHttpUrl(fallback) ? fallback : null;
        if (!chosen) { showToast(`Missing PAB URL for ${username}`,'bad'); return null; }
        a = a.replace('{url}', chosen);
      }
      const clean = sanitiseArgs(a);
      if (a && !clean) showToast(`Args rejected by whitelist for ${username}`,'warn');
      return isPresent(clean) ? clean : null;
    }
    async function apiUpdateField(username, field, value){
      const body = {};
      body[field] = value;
      await safeFetch(`${API_BASE}/api/accounts/${encodeURIComponent(username)}`, {
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
    }
    async function apiStart(username, plugin, args){
      const payload = {};
      if (isPresent(plugin)) payload.plugin = plugin;
      if (isPresent(args)) payload.args = args;
      await safeFetch(`${API_BASE}/api/accounts/${encodeURIComponent(username)}/start`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
    }
    async function apiStop(username){
      await safeFetch(`${API_BASE}/api/accounts/${encodeURIComponent(username)}/stop`, { method:'POST' });
    }
    async function overlayGet(username){
      try {
        const r = await safeFetch(`${API_BASE}/overlay/${encodeURIComponent(username)}`);
        return await r.json();
      } catch (e) { return {}; }
    }
    async function overlaySave(username, patch){
      await safeFetch(`${API_BASE}/overlay/${encodeURIComponent(username)}`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(patch)
      });
    }
    async function fetchBankValues() {
      for (const acc of accounts) {
        const ov = overlays.get(acc.username) || {};
        if (acc.rsn && acc.rsn.trim() !== '') {
          try {
            const res = await safeFetch(`${AGENT_BASE}/api/stats/${encodeURIComponent(acc.username)}`, {}, 15000);
            const stats = await res.json();
            if (stats.bankValue !== null && stats.bankValue !== undefined) ov.bankValue = stats.bankValue;
            if (stats.coins !== null && stats.coins !== undefined) ov.coins = stats.coins;
            if (stats.membershipDays !== null && stats.membershipDays !== undefined) ov.membershipDays = stats.membershipDays;
          } catch (e) {}
        }
        try {
          const logsRes = await safeFetch(`${AGENT_BASE}/api/logs/${encodeURIComponent(acc.username)}`, {}, 10000);
          const logsData = await logsRes.json();
          if (logsData.currentTask) {
            ov.currentTask = logsData.currentTask;
            await overlaySave(acc.username, { currentTask: logsData.currentTask });
          } else if (logsData.logs) {
            const extracted = extractCurrentTask(logsData.logs);
            if (extracted) {
              ov.currentTask = extracted;
              await overlaySave(acc.username, { currentTask: extracted });
            } else {
              ov.currentTask = acc.status === 'running' ? 'Unknown' : 'Stopped';
            }
          } else {
            ov.currentTask = acc.status === 'running' ? 'Unknown' : 'Stopped';
          }
        } catch (e) {
          ov.currentTask = acc.status === 'running' ? 'Unknown' : 'Stopped';
        }
        overlays.set(acc.username, ov);
      }
    }
    function extractCurrentTask(logs) {
      const lines = logs.split('\n');
      const executingPattern = /Executing task: (.+)$/;
      const startingPattern = /Starting task: (.+)$/;
      const stoppedPattern = /PAccountBuilder: (Stopped|Hotkey pressed)/;
      for (let i = lines.length - 1; i >= 0; i--) {
        const line = lines[i];
        if (stoppedPattern.test(line)) return 'Stopped';
        const execMatch = line.match(executingPattern);
        if (execMatch) return execMatch[1];
        const startMatch = line.match(startingPattern);
        if (startMatch) return startMatch[1];
      }
      return null;
    }
	async function refreshAccounts(){
	  if (Date.now() < pauseUntil) return;
	  if (currentTab === 'accounts') return;  // ← BLOCK
	  if (blockRenderAccounts) return;

	  try {
		const r = await safeFetch(`${API_BASE}/api/accounts`);
		accounts = await r.json();
        for (const a of accounts) markSeen(a);
        for (const a of accounts){
          const existing = overlays.get(a.username) || {};
          const fetched = await overlayGet(a.username);
          overlays.set(a.username, { ...existing, ...fetched });
        }
        renderAccounts();
        renderBans();
        updateStats();
        const el = document.getElementById('connection-status');
        if (el) {
          el.textContent = 'Connected';
          el.className = 'connection-status status-connected';
        }
        await fetchBankValues();
        renderOverview();
        stallGuard();
      } catch (e) {
        console.error('Error in refreshAccounts:', e);
        const el = document.getElementById('connection-status');
        if (el) {
          el.textContent = 'Disconnected';
          el.className = 'connection-status status-disconnected';
        }
        stallGuard();
      }
    }
    function updateStats(){
      const total = accounts.length;
      const running = accounts.filter(a => deriveUiStatus(a) === 'running').length;
      const stopped = accounts.filter(a => deriveUiStatus(a) === 'stopped').length;
      const stalled = accounts.filter(a => deriveUiStatus(a) === 'stalled').length;
      const dcerror = accounts.filter(a => deriveUiStatus(a) === 'dcerror').length;
      const totalEl = document.getElementById('total-accounts'); if (totalEl) totalEl.textContent = total;
      const runningEl = document.getElementById('running-accounts'); if (runningEl) runningEl.textContent = running;
      const stoppedEl = document.getElementById('stopped-accounts'); if (stoppedEl) stoppedEl.textContent = stopped;
      const stalledEl = document.getElementById('stalled-accounts'); if (stalledEl) stalledEl.textContent = stalled;
      const dcerrorEl = document.getElementById('dcerror-accounts'); if (dcerrorEl) dcerrorEl.textContent = dcerror;
      const selectedEl = document.getElementById('selected-accounts'); if (selectedEl) selectedEl.textContent = selectedAccounts.size;
      if (stalledEl) stalledEl.style.animation = stalled > 0 ? 'pulse 2s ease-in-out infinite' : 'none';
      if (dcerrorEl) dcerrorEl.style.animation = dcerror > 0 ? 'pulse 2s ease-in-out infinite' : 'none';
    }
    function calculateRuntime(startTime){
      if (!startTime) return '-';
      const diff = Math.max(0, (Date.now() - new Date(startTime).getTime())/1000|0);
      const h = Math.floor(diff/3600), m = Math.floor((diff%3600)/60);
      return h>0?`${h}h ${m}m`:`${m}m`;
    }
    function generatePluginOptions(currentLabel){
      const groups = {
        'Account Building': [
          ['AccountBuilder','paccountbuilder.autostart=true'],
          ['AccountBuilder URL','paccountbuilder.autostart={url}&paccountbuilder.logindelay=15000'],
        ],
        'El Plugins': [
          ['El Miner','el.start=Miner'],['El Woodcutter','el.start=Woodcutter'],['El Fisher','el.start=Fisher'],
          ['El Agility','el.start=Agility'],['El Cooker','el.start=Cooker'],['El Firemaker','el.start=Firemaker'],
          ['El Hunter','el.start=Hunter'],['El Thieving','el.start=Thieving']
        ],
        'Repcal Plugins': [
          ['Repcal Fighter','repcal.start=Fighter'],['Repcal Magic','repcal.start=Magic'],
          ['Repcal Slayer','repcal.start=Slayer'],['Repcal Ranger','repcal.start=Ranger']
        ],
        'Demon Plugins': [
          ['Aerial Fishing','demon.start=aerialfishing'],['Agility Suite','demon.start=agilitysuite'],
          ['Arceuus Library','demon.start=arceuuslibrary'],['AutoLogHop','demon.start=demonautologhop'],
          ['Bankstander','demon.start=bankstander'],['Blast Furnace','demon.start=demonbf'],
          ['Brimhaven Arena','demon.start=brimhavenarena'],['Chef\'s Delight','demon.start=tickcooker'],
          ['Hotkeys','demon.start=demonhotkeys'],['Fighter','demon.start=demonfighter'],
          ['Finds Cleaner','demon.start=findscleaner'],['Fishing Suite','demon.start=fishingsuite'],
          ['Flipper','demon.start=flipper'],['Gauntlet Helper','demon.start=gauntlethelper'],
          ['Giants Foundry','demon.start=giantsfoundry'],['Hallowed Sepulchre','demon.start=hallowedsepulchre'],
          ['Herblore Suite','demon.start=herbloresuite'],['Lizardman Temple','demon.start=lizardmanshamans'],
          ['MTA','demon.start=demonMTA'],['Mastering Mixology','demon.start=masteringmixology'],
          ['Mining Suite','demon.start=miningsuite'],['Planker','demon.start=plankmaker'],
          ['Pest Control','demon.start=demonpc'],['Prayer Suite','demon.start=prayersuite'],
          ['PVP Arena','demon.start=demonpvparena'],['Pyramid Plunder','demon.start=pyramidplunder'],
          ['Scurrius','demon.start=ratboss'],['Royal Titans','demon.start=demonroyaltitans'],
          ['Shopper','demon.start=shopper'],['Temple Trekking','demon.start=demontempletrek'],
          ['Thieving Suite','demon.start=thievingsuite'],['Tithe Farm','demon.start=demontithefarm'],
          ['Tormented Demons','demon.start=demonstormented'],['Vale Totems','demon.start=valetotems'],
          ['Wintertodt','demon.start=demonwintertodt'],['Woodcutting Suite','demon.start=woodcuttingsuite']
        ],
        'Other': [['Break Handler','bh.creds=true'],['Custom','']]
      };
      let html = '<option value="">-- No Plugin --</option>';
      for (const [group, list] of Object.entries(groups)){
        html += `<optgroup label="${escapeHtml(group)}">`;
        for (const [name, args] of list){
          const sel = name===currentLabel?'selected':'';
          const v = `${name}|${args}`;
          html += `<option value="${escapeHtml(v)}" ${sel}>${escapeHtml(name)}</option>`;
        }
        html += '</optgroup>';
      }
      return html;
    }
	function renderAccounts(){
	  if (blockRenderAccounts) return;
      const tbody = document.getElementById('accounts-tbody');
      const countEl = document.getElementById('account-count');
      if (!tbody || !countEl) return;
      const q = (document.getElementById('search-accounts')?.value||'').toLowerCase();
      const filtered = accounts.filter(a =>
        a.username.toLowerCase().includes(q) ||
        (a.plugin||'').toLowerCase().includes(q) ||
        (a.args||'').toLowerCase().includes(q)
      );
      countEl.textContent = `${filtered.length} accounts`;
      const rows = filtered.map(acc=>{
        const user = escapeHtml(acc.username);
        const plugin = escapeHtml(acc.plugin||'');
        const args = escapeHtml(acc.args||'');
        const ov = overlays.get(acc.username) || {};
        const pabUrl = escapeHtml(ov.pabUrl||'');
        const proxy = escapeHtml(acc.proxy||'');
        const effStatus = deriveUiStatus(acc);
        const statusClass = effStatus === 'running' ? 'status-running'
           : effStatus === 'stopped' ? 'status-stopped'
           : effStatus === 'starting' ? 'status-starting'
           : effStatus === 'queued' ? 'status-queued'
           : effStatus === 'stalled' ? 'status-stalled'
           : effStatus === 'dcerror' ? 'status-stalled'
           : 'status-offline';
        const statusIcon = effStatus==='running'?'<span class="live-dot"></span>'
          : effStatus==='stopped'?''
          : effStatus==='starting'?''
          : effStatus==='queued'?''
          : effStatus==='stalled'?''
          : effStatus==='dcerror'?''
          : '';
        const server = escapeHtml(acc.server||'agent_a');
        const pid = acc.pid ? String(acc.pid) : '-';
        const runtime = calculateRuntime(acc.startTime);
        const checked = selectedAccounts.has(acc.username) ? 'checked' : '';
        return `
          <tr data-username="${user}">
            <td class="checkbox-cell"><input type="checkbox" class="account-checkbox" ${checked} /></td>
            <td><strong>${user}</strong></td>
            <td><input class="editable-select js-rsn" value="${escapeHtml(acc.rsn||'')}" placeholder="RSN" /></td>
            <td><span class="status-badge ${statusClass}">${statusIcon} ${effStatus}</span></td>
            <td><select class="editable-select js-plugin">${generatePluginOptions(plugin)}</select></td>
            <td><input class="editable-select js-args" value="${args}" placeholder="key=val&k2=v2" /></td>
            <td><input class="editable-select js-pab-url" value="${pabUrl}" placeholder="https://task.json" /></td>
            <td><input class="editable-select js-proxy" value="${proxy}" placeholder="host:port:user:pass" /></td>
            <td>${server}</td>
            <td>${pid}</td>
            <td>${runtime}</td>
            <td>
              <button class="btn btn-primary action-btn js-start">Start</button>
              <button class="btn btn-bad action-btn js-stop">Stop</button>
            </td>
          </tr>
        `;
      }).join('');
      tbody.innerHTML = rows;
    }
    function renderBans(){
      const body = document.getElementById('bans-tbody');
      if (!body) return;
      const filter = document.getElementById('ban-filter')?.value || 'all';
      const q = (document.getElementById('ban-search')?.value||'').toLowerCase();
      const list = accounts.map(a=>{
        const ov = overlays.get(a.username)||{};
        return { user:a.username, ban:!!ov.banFlag, note:ov.banNote||'' };
      }).filter(r=>{
        if (filter==='banned' && !r.ban) return false;
        if (filter==='clear' && r.ban) return false;
        if (q && !(r.user.toLowerCase().includes(q) || r.note.toLowerCase().includes(q))) return false;
        return true;
      });
      body.innerHTML = list.map(r=>{
        return `<tr data-username="${escapeHtml(r.user)}">
          <td><strong>${escapeHtml(r.user)}</strong></td>
          <td class="checkbox-cell"><input type="checkbox" class="js-ban" ${r.ban?'checked':''}></td>
          <td><input class="editable-select js-ban-note" value="${escapeHtml(r.note)}" placeholder="Reason or context"></td>
          <td><button class="btn btn-ok js-ban-save">Save</button></td>
        </tr>`;
      }).join('');
    }
	function wireStaticEvents(){
	let blockRenderAccounts = false;
	

	document.querySelectorAll('.tab').forEach(tab => {
	  tab.addEventListener('click', () => {
		document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
		document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
		tab.classList.add('active');
		const target = document.getElementById(`${tab.dataset.tab}-tab`);
		if (target) target.classList.add('active');

		const newTab = tab.dataset.tab;
		if (newTab === 'accounts') {
		  if (autoRefreshEnabled) {
			stopAutoRefresh();
			showToast('Auto-refresh paused (Accounts tab)', 'info');
		  }
		  blockRenderAccounts = true;
		  const status = document.getElementById('refresh-status');
		  if (status) status.textContent = 'Auto-refresh paused';
		} else {
		  if (!autoRefreshEnabled && currentTab === 'accounts') {
			startAutoRefresh();
			showToast('Auto-refresh resumed', 'ok');
		  }
		  blockRenderAccounts = false;
		  const status = document.getElementById('refresh-status');
		  if (status) status.textContent = '';
		}
		currentTab = newTab;
	  });
	});

	// === MANUAL REFRESH BUTTON ===
	const manualRefreshBtn = document.getElementById('btn-manual-refresh');
	if (manualRefreshBtn) {
	  manualRefreshBtn.onclick = async () => {
		manualRefreshBtn.disabled = true;
		manualRefreshBtn.textContent = 'Refreshing...';
		await refreshAccounts();
		manualRefreshBtn.disabled = false;
		manualRefreshBtn.textContent = 'Refresh Now';
		showToast('Accounts refreshed', 'ok');
	  };
	}

      // === BULK ACTIONS ===
      const bulkStart = document.getElementById('btn-bulk-start');
      if (bulkStart) bulkStart.onclick = async () => {
        const selected = Array.from(selectedAccounts);
        if (selected.length === 0) return showToast('Select accounts first', 'bad');
        const delaySeconds = settings.delay || 10;
        for (let i = 0; i < selected.length; i++) {
          const username = selected[i];
          const acc = accounts.find(a => a.username === username);
          if (!acc || !acc.plugin) {
            showToast(`${username}: No plugin set!`, 'warn');
            continue;
          }
          try {
            await apiStart(username, acc.plugin, acc.args ?? undefined);
            showToast(`Started ${username} (${i + 1}/${selected.length})`, 'ok');
            await refreshAccounts();
            if (i < selected.length - 1) {
              appendFeed(`Waiting ${delaySeconds}s before next launch...`);
              await sleep(delaySeconds * 1000);
            }
          } catch (e) {
            showToast(`Failed to start ${username}: ${e.message}`, 'bad');
          }
        }
        showToast(`Finished launching ${selected.length} accounts`, 'ok');
        await refreshAccounts();
      };

      const bulkStop = document.getElementById('btn-bulk-stop');
      if (bulkStop) bulkStop.onclick = async () => {
        const selected = Array.from(selectedAccounts);
        if (selected.length === 0) return showToast('Select accounts first', 'bad');
        pauseRefresh(3500);
        for (const u of selected) {
          try {
            await apiStop(u);
            showToast(`Stopped ${u}`, 'ok');
          } catch (e) {
            showToast(`Failed to stop ${u}`, 'bad');
          }
        }
        setTimeout(refreshAccounts, 1000);
      };

      const bulkRestart = document.getElementById('btn-bulk-restart');
      if (bulkRestart) bulkRestart.onclick = async () => {
        await bulkStop.onclick();
        await sleep(2000);
        await bulkStart.onclick();
      };

      // === SEARCH & SETTINGS ===
      const search = document.getElementById('search-accounts');
      if (search) search.addEventListener('input', renderAccounts);

      const saveSettingsBtn = document.getElementById('btn-save-settings');
      if (saveSettingsBtn) saveSettingsBtn.onclick = saveSettings;

      const savePlBtn = document.getElementById('btn-save-pl');
      if (savePlBtn) savePlBtn.onclick = () => {
        settings.pureLauncherPath = document.getElementById('purelauncher-path')?.value.trim() || '';
        saveSettings();
        safeFetch(`${API_BASE}/api/purelauncher-path`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: settings.pureLauncherPath })
        }).catch(() => {});
        showToast('Path saved', 'ok');
      };

      const testPlBtn = document.getElementById('btn-test-pl');
      if (testPlBtn) testPlBtn.onclick = async () => {
        showToast('Testing PureLauncher…', 'info');
        try {
          const res = await safeFetch(`${API_BASE}/api/test-purelauncher`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: document.getElementById('purelauncher-path')?.value.trim() || '' })
          });
          const j = await res.json();
          if (j.success) {
            const st = document.getElementById('pl-status');
            if (st) {
              st.textContent = 'Connected';
              st.className = 'connection-status status-connected';
            }
            showToast('OK', 'ok');
          } else throw new Error('fail');
        } catch (e) {
          const st = document.getElementById('pl-status');
          if (st) {
            stテキスト = 'Not found';
            st.className = 'connection-status status-disconnected';
          }
          showToast('Not found', 'bad');
        }
      };

      // === PROXY & STOP ALL ===
      const updateProxyBtn = document.getElementById('btn-update-proxy');
      if (updateProxyBtn) updateProxyBtn.onclick = async () => {
        const pv = document.getElementById('batch-proxy')?.value.trim() || '';
        const targets = Array.from(selectedAccounts);
        if (targets.length === 0) return showToast('Select accounts first', 'warn');
        for (const u of targets) await apiUpdateField(u, 'proxy', pv);
        showToast('Proxy updated', 'ok');
        refreshAccounts();
      };

      const stopAllBtn = document.getElementById('btn-stop-all');
      if (stopAllBtn) stopAllBtn.onclick = async () => {
        if (!confirm('Stop ALL running bots?')) return;
        try { await safeFetch(`${API_BASE}/api/stop-all`, { method: 'POST' }); } catch (e) {}
        refreshAccounts();
        showToast('All stopped', 'ok');
      };

      const clearBtn = document.getElementById('btn-clear');
      if (clearBtn) clearBtn.onclick = () => {
        localStorage.clear();
        showToast('Local data cleared', 'warn');
      };

      const exportBtn = document.getElementById('btn-export');
      if (exportBtn) exportBtn.onclick = () => {
        const dataStr = JSON.stringify(accounts, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'accounts_export.json';
        a.click();
        URL.revokeObjectURL(url);
      };

      // === SELECT ALL ===
      const selectAll = document.getElementById('select-all');
      if (selectAll) selectAll.addEventListener('change', (e) => {
        const all = !!e.target.checked;
        document.querySelectorAll('#accounts-tbody .account-checkbox').forEach(cb => {
          cb.checked = all;
          const u = cb.closest('tr').dataset.username;
          if (all) selectedAccounts.add(u); else selectedAccounts.delete(u);
        });
        updateStats();
      });

      // === INPUT HANDLERS (RSN, ARGS, PAB, PROXY) ===
      const accountsTbody = document.getElementById('accounts-tbody');
      if (accountsTbody) {
        // Plugin change with debounce
        let pluginChangeTimeout = null;
        accountsTbody.addEventListener('change', async (e) => {
          const row = e.target.closest('tr');
          if (!row) return;
          const username = row.dataset.username;

          if (e.target.classList.contains('account-checkbox')) {
            if (e.target.checked) selectedAccounts.add(username);
            else selectedAccounts.delete(username);
            updateStats();
            return;
          }

          if (e.target.classList.contains('js-plugin')) {
            clearTimeout(pluginChangeTimeout);
            pluginChangeTimeout = setTimeout(async () => {
              const val = e.target.value || '';
              const [plugin, argsTemplate = ''] = val.split('|');
              if (!isPresent(plugin)) {
                showToast('Empty plugin ignored', 'warn');
                return;
              }
              await apiUpdateField(username, 'plugin', plugin);
              const argsInput = row.querySelector('.js-args');
              if (argsInput) argsInput.value = argsTemplate;

              if (argsTemplate.includes('{url}')) {
                const resolved = resolveArgsForUser(argsTemplate, username);
                if (resolved !== null) {
                  argsInput.value = resolved;
                  await apiUpdateField(username, 'args', resolved);
                  showToast(`Saved ${username} with URL`, 'ok');
                } else {
                  showToast(`${username}: Set PAB URL first!`, 'warn');
                }
              } else if (argsTemplate) {
                await apiUpdateField(username, 'args', argsTemplate);
              }
              showToast(`Plugin saved: ${plugin}`, 'ok');
            }, 600);
          }
        });

        // Blur handlers for RSN, Args, PAB URL, Proxy
        accountsTbody.addEventListener('blur', async (e) => {
          const row = e.target.closest('tr');
          if (!row) return;
          const username = row.dataset.username;

          if (e.target.classList.contains('js-rsn')) {
            const rsn = e.target.value.trim();
            await apiUpdateField(username, 'rsn', rsn);
            showToast(`RSN saved for ${username}`, 'ok');
          }

          if (e.target.classList.contains('js-args')) {
            const raw = e.target.value.trim();
            if (raw === '') return;
            const cleaned = resolveArgsForUser(raw, username);
            if (cleaned === null) return;
            await apiUpdateField(username, 'args', cleaned);
            e.target.value = cleaned;
            showToast(`Args saved for ${username}`, 'ok');
          }

          if (e.target.classList.contains('js-pab-url')) {
            let url = e.target.value.trim();
            if (url && !isHttpUrl(url)) {
              showToast('Invalid URL', 'bad');
              return;
            }
            url = normalizePabUrl(url);
            await overlaySave(username, { pabUrl: url });
            overlays.set(username, { ...(overlays.get(username) || {}), pabUrl: url });
            e.target.value = url;

            const pluginSelect = row.querySelector('.js-plugin');
            if (pluginSelect && pluginSelect.value.includes('AccountBuilder URL')) {
              const argsInput = row.querySelector('.js-args');
              if (argsInput && argsInput.value.includes('{url}')) {
                const resolved = resolveArgsForUser(argsInput.value, username);
                if (resolved) {
                  argsInput.value = resolved;
                  await apiUpdateField(username, 'args', resolved);
                  showToast('PAB URL & Args updated!', 'ok');
                  return;
                }
              }
            }
            showToast('PAB URL saved (normalized)', 'ok');
          }

          if (e.target.classList.contains('js-proxy')) {
            const proxy = e.target.value.trim();
            await apiUpdateField(username, 'proxy', proxy);
            showToast(`Proxy saved for ${username}`, 'ok');
          }
        }, true);

        // Start/Stop buttons
        accountsTbody.addEventListener('click', async (e) => {
          const row = e.target.closest('tr');
          if (!row) return;
          const username = row.dataset.username;

          if (e.target.closest('.js-start')) {
            const sel = row.querySelector('.js-plugin').value || '';
            let plugin, argsRaw;
            if (sel.includes('|')) {
              [plugin, argsRaw] = sel.split('|');
            } else {
              plugin = 'demon';
              argsRaw = sel || '';
            }
            if (!isPresent(plugin)) {
              showToast('Pick a plugin', 'bad');
              return;
            }
            const manualArgs = row.querySelector('.js-args').value.trim();
            const argsToResolve = manualArgs || argsRaw || '';
            const final = resolveArgsForUser(argsToResolve, username);
            if (argsToResolve.includes('{url}') && final === null) {
              showToast(`Cannot start ${username}: Set PAB URL first!`, 'bad');
              return;
            }
            try {
              await apiUpdateField(username, 'plugin', plugin);
              if (final !== null) await apiUpdateField(username, 'args', final);
              await apiStart(username, plugin, final ?? undefined);
              showToast(`Started ${username}`, 'ok');
              refreshAccounts();
            } catch (err) {
              console.error('Start error:', err);
              showToast(`Start failed: ${err.message || 'Unknown error'}`, 'bad');
            }
          }

          if (e.target.closest('.js-stop')) {
            try {
              await apiStop(username);
              showToast(`Stopped ${username}`, 'ok');
              refreshAccounts();
            } catch (err) {
              showToast(`Stop failed ${username}`, 'bad');
            }
          }
        });
      }

      // === BANS TAB ===
      const banFilter = document.getElementById('ban-filter');
      if (banFilter) banFilter.addEventListener('change', renderBans);
      const banSearch = document.getElementById('ban-search');
      if (banSearch) banSearch.addEventListener('input', renderBans);
      const bansTbody = document.getElementById('bans-tbody');
      if (bansTbody) {
        bansTbody.addEventListener('click', async (e) => {
          const row = e.target.closest('tr');
          if (!row) return;
          const username = row.dataset.username;
          if (e.target.classList.contains('js-ban-save')) {
            const ban = row.querySelector('.js-ban').checked;
            const note = row.querySelector('.js-ban-note').value.trim();
            await overlaySave(username, { banFlag: ban, banNote: note });
            overlays.set(username, { ...(overlays.get(username) || {}), banFlag: ban, banNote: note });
            showToast('Saved', 'ok');
          }
        });
      }

      // === HISCORES TAB ===
      const hsFromSelected = document.getElementById('hs-from-selected');
      if (hsFromSelected) hsFromSelected.onclick = () => {
        const first = Array.from(selectedAccounts)[0];
        if (!first) return showToast('Select an account', 'warn');
        const acc = accounts.find(a => a.username === first);
        if (!acc || !acc.rsn || acc.rsn.trim() === '') {
          showToast('Please set RSN for this account in Account Management first!', 'warn');
          return;
        }
        document.getElementById('hs-user').value = acc.rsn;
      };

      const hsFetch = document.getElementById('hs-fetch');
      if (hsFetch) hsFetch.onclick = async () => {
        const u = document.getElementById('hs-user').value.trim();
        if (!u) return showToast('Enter username', 'warn');
        try {
          const r = await safeFetch(`${API_BASE}/api/hiscores?username=${encodeURIComponent(u)}`);
          const j = await r.json();
          if (!j || !j.meta) {
            document.getElementById('hs-result').innerHTML = '<p>No data</p>';
            return;
          }
          const core = j.skills || {};
          const totalLvl = core.overall?.level ?? '-';
          const totalXp = core.overall?.xp ?? '-';
          const hdr = `<div style="margin-bottom:8px"><strong>${escapeHtml(j.meta.username)}</strong> • Total: ${totalLvl} (${totalXp} xp)</div>`;
          const order = ['attack','strength','defence','ranged','magic','hitpoints','prayer','slayer','agility','thieving','fletching','herblore','crafting','runecraft','mining','smithing','fishing','cooking','firemaking','woodcutting','farming','construction','hunter','overall'];
          const rows = order.filter(k => core[k]).map(k => `<tr><td>${k}</td><td>${core[k].level}</td><td>${core[k].xp}</td><td>${core[k].rank}</td></tr>`).join('');
          document.getElementById('hs-result').innerHTML =
            hdr + `<table><thead><tr><th>Skill</th><th>Lvl</th><th>XP</th><th>Rank</th></tr></thead><tbody>${rows}</tbody></table>`;
        } catch (e) {
          document.getElementById('hs-result').innerHTML = '<p>Error fetching hiscores</p>';
        }
      };

      const hsRefreshAll = document.getElementById('hs-refresh-all');
      if (hsRefreshAll) hsRefreshAll.onclick = async () => {
        const accountsWithRSN = accounts.filter(a => a.rsn && a.rsn.trim() !== '');
        if (accountsWithRSN.length === 0) {
          showToast('No accounts have RSN set! Add RSN in Account Management tab.', 'warn');
          return;
        }
        const container = document.getElementById('hs-all-accounts');
        if (!container) return;
        container.innerHTML = `<p>Loading hiscores for ${accountsWithRSN.length} accounts...</p>`;
        let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:20px;margin-top:16px">';
        for (const acc of accountsWithRSN) {
          try {
            const r = await safeFetch(`${API_BASE}/api/hiscores?username=${encodeURIComponent(acc.rsn)}`);
            const j = await r.json();
            if (j && j.meta && j.skills) {
              const core = j.skills;
              const totalLvl = core.overall?.level ?? '-';
              const totalXp = core.overall?.xp ?? '-';
              const combat = ['attack','strength','defence','hitpoints','ranged','prayer','magic'];
              const combatHTML = combat.filter(k => core[k]).map(k =>
                `<div style="display:flex;justify-content:space-between;padding:4px 8px;background:#2a3a4a;border-radius:4px;margin-bottom:2px">
                  <span style="text-transform:capitalize;font-weight:500">${k}</span>
                  <span style="color:#4a9eff;font-weight:bold">${core[k].level}</span>
                </div>`
              ).join('');
              const support = ['slayer','agility','thieving','fletching','herblore','crafting','runecraft','mining','smithing','fishing','cooking','firemaking','woodcutting','farming','construction','hunter'];
              const supportHTML = support.filter(k => core[k]).map(k =>
                `<div style="display:flex;justify-content:space-between;padding:4px 8px;background:#2a3a4a;border-radius:4px;margin-bottom:2px">
                  <span style="text-transform:capitalize;font-weight:500">${k}</span>
                  <span style="color:#4a9eff;font-weight:bold">${core[k].level}</span>
                </div>`
              ).join('');
              html += `
                <div style="border:2px solid #3a4a5a;border-radius:12px;padding:16px;background:linear-gradient(135deg, #1e2936 0%, #2a3444 100%);box-shadow:0 4px 6px rgba(0,0,0,0.3)">
                  <div style="border-bottom:2px solid #3a4a5a;padding-bottom:12px;margin-bottom:12px">
                    <div style="font-size:18px;font-weight:bold;color:#4a9eff;margin-bottom:4px">${escapeHtml(acc.rsn)}</div>
                    <div style="font-size:12px;color:#8a9aa5">${escapeHtml(acc.username)}</div>
                    <div style="margin-top:8px;font-size:14px;color:#6a9aff">
                      <strong>Total Level:</strong> ${totalLvl} | <strong>XP:</strong> ${Number(totalXp).toLocaleString()}
                    </div>
                  </div>
                  <div style="margin-bottom:12px">
                    <div style="font-size:13px;font-weight:bold;color:#ff9a4a;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px">Combat</div>
                    ${combatHTML}
                  </div>
                  <div>
                    <div style="font-size:13px;font-weight:bold;color:#4aff9a;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px">Skills</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0 8px">
                      ${supportHTML}
                    </div>
                  </div>
                </div>
              `;
            } else {
              html += `
                <div style="border:2px solid #5a3a3a;border-radius:12px;padding:16px;background:#2e1e1e;box-shadow:0 4px 6px rgba(0,0,0,0.3)">
                  <div style="font-size:18px;font-weight:bold;color:#ff6b6b">${escapeHtml(acc.rsn)}</div>
                  <div style="font-size:12px;color:#8a6a6a;margin-top:8px">No hiscores data found</div>
                </div>
              `;
            }
          } catch (e) {
            html += `
              <div style="border:2px solid #5a3a lobe;border-radius:12px;padding:16px;background:#2e1e1e;box-shadow:0 4px 6px rgba(0,0,0,0.3)">
                <div style="font-size:18px;font-weight:bold;color:#ff6b6b">${escapeHtml(acc.rsn)}</div>
                <div style="font-size:12px;color:#8a6a6a;margin-top:8px">Error loading hiscores</div>
              </div>
            `;
          }
        }
        html += '</div>';
        container.innerHTML = html;
        showToast(`Loaded ${accountsWithRSN.length} accounts`, 'ok');
      };
    }
    let overviewFilter = 'all';
    function filterOverview(filter) {
      overviewFilter = filter;
      document.querySelectorAll('[data-filter]').forEach(btn => {
        if (btn.dataset.filter === filter) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      renderOverview();
    }
    function renderOverview(){
      const grid = document.getElementById('overview-grid');
      if(!grid) return;
      if(accounts.length === 0){
        grid.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted);grid-column:1/-1">No accounts found</div>';
        return;
      }
      let filteredAccounts = accounts;
      if (overviewFilter !== 'all') {
        filteredAccounts = accounts.filter(acc => {
          const effStatus = deriveUiStatus(acc);
          return effStatus === overviewFilter;
        });
      }
      filteredAccounts.sort((a, b) => {
        const aStatus = deriveUiStatus(a);
        const bStatus = deriveUiStatus(b);
        if (aStatus === 'dcerror' && bStatus !== 'dcerror') return -1;
        if (bStatus === 'dcerror' && aStatus !== 'dcerror') return 1;
        if (aStatus === 'stalled' && bStatus !== 'stalled') return -1;
        if (bStatus === 'stalled' && aStatus !== 'stalled') return 1;
        const statusOrder = { running: 1, starting: 2, queued: 3, stopped: 4, offline: 5 };
        return (statusOrder[aStatus] || 999) - (statusOrder[bStatus] || 999);
      });
      if (filteredAccounts.length === 0) {
        grid.innerHTML = `<div style="text-align:center;padding:40px;color:var(--muted);grid-column:1/-1">No ${overviewFilter} accounts</div>`;
        return;
      }
      let totalGP = 0, running = 0, totalMem = 0, memCount = 0;
      grid.innerHTML = filteredAccounts.map(acc => {
        const ov = overlays.get(acc.username) || {};
        const displayName = acc.rsn || acc.username.split('@')[0];
        const currentTask = ov.currentTask || acc.plugin || 'Idle';
        const effStatus = deriveUiStatus(acc);
        if (effStatus === 'running') running++;
        if (ov.bankValue) totalGP += ov.bankValue;
        if (ov.membershipDays) { totalMem += ov.membershipDays; memCount++; }

        let statusColor, statusBg, statusBorder, statusLabel;
        if (effStatus === 'running') {
          statusColor = '#22c55e'; statusBg = '#0d1a12'; statusBorder = '#193021'; statusLabel = 'RUNNING';
        } else if (effStatus === 'starting') {
          statusColor = '#3b82f6'; statusBg = '#0c1625'; statusBorder = '#152236'; statusLabel = 'STARTING';
        } else if (effStatus === 'stalled') {
          statusColor = '#f59e0b'; statusBg = '#231a0b'; statusBorder = '#33240c'; statusLabel = 'STALLED';
        } else if (effStatus === 'dcerror') {
          statusColor = '#fca5a5'; statusBg = '#2a0f0f'; statusBorder = '#3c1515'; statusLabel = 'DC/ERROR';
        } else if (effStatus === 'queued') {
          statusColor = '#f59e0b'; statusBg = '#231a0b'; statusBorder = '#33240c'; statusLabel = 'QUEUED';
        } else {
          statusColor = '#ef4444'; statusBg = '#1a0d0d'; statusBorder = '#301515'; statusLabel = 'STOPPED';
        }
        const cardBorder = (effStatus === 'stalled' || effStatus === 'dcerror') ? '2px solid #ef4444' : '1px solid #333333'; // FIXED
        const runtime = calculateRuntime(acc.startTime);
        return `
          <div style="background:linear-gradient(135deg,rgba(255,106,0,0.03),rgba(18,18,21,0.95));border:${cardBorder};border-radius:10px;padding:14px;transition:transform 0.2s">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
			<div style="font-weight:700;font-size:16px;color:var(--brand-light);cursor:pointer" 
				 onclick="navigator.clipboard.writeText('${escapeHtml(displayName)}');showToast('RSN copied!', 'ok')">
			  ${escapeHtml(displayName)}
			</div>
              <span style="padding:4px 8px;border-radius:999px;font-size:10px;font-weight:800;color:${statusColor};background:${statusBg};border:1px solid ${statusBorder}">
                ${effStatus === 'running' ? '<span class="live-dot"></span>' : ''}${statusLabel}
              </span>
            </div>
            <div style="font-size:13px;background:rgba(255,106,0,0.08);padding:6px 10px;border-radius:6px;margin:8px 0;border-left:3px solid var(--brand)">
              ${escapeHtml(currentTask)}
            </div>
            <div style="display:flex;gap:12px;margin-top:10px">
              <div style="flex:1;text-align:center">
                <div style="font-size:10px;color:var(--muted);text-transform:uppercase">Bank Value</div>
                <div style="font-size:16px;font-weight:700;color:#22c55e">${formatGP(ov.bankValue)}</div>
              </div>
              <div style="flex:1;text-align:center">
                <div style="font-size:10px;color:var(--muted);text-transform:uppercase">Coins</div>
                <div style="font-size:16px;font-weight:700;color:#fbbf24">${formatGP(ov.coins)}</div>
              </div>
              <div style="flex:1;text-align:center">
                <div style="font-size:10px;color:var(--muted);text-transform:uppercase">Membership</div>
                <div style="font-size:16px;font-weight:700;color:#f59e0b">${ov.membershipDays ? ov.membershipDays + ' days' : 'N/A'}</div>
              </div>
            </div>
            <div style="display:flex;gap:6px;margin-top:12px">
              <button class="btn btn-primary" style="flex:1;font-size:12px" onclick="startBot('${acc.username}')">Start</button>
              <button class="btn btn-warn" style="flex:1;font-size:12px" onclick="restartBot('${acc.username}')">Restart</button>
              <button class="btn btn-bad" style="flex:1;font-size:12px" onclick="stopBot('${acc.username}')">Stop</button>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('running-count').textContent = running;
      document.getElementById('total-gp').textContent = formatGP(totalGP);
      document.getElementById('avg-mem').textContent = memCount > 0 ? Math.round(totalMem / memCount) + 'd' : '0d';
    }

    async function startBot(u) {
      await safeFetch(`${API_BASE}/api/accounts/${u}/start`, { method: 'POST' });
      showToast(`Started ${u}`, 'ok');
      refreshAccounts();
    }
    async function stopBot(u) {
      await safeFetch(`${API_BASE}/api/accounts/${u}/stop`, { method: 'POST' });
      showToast(`Stopped ${u}`, 'ok');
      refreshAccounts();
    }
    async function restartBot(u) {
      await stopBot(u);
      await sleep(2000);
      await startBot(u);
    }

    // === INIT ===
    document.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      wireStaticEvents();
      refreshAccounts();
      startAutoRefresh();
    });
  </script>
</body>
</html>